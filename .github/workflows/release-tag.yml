name: Release (tag) - binaries + docker

on:
  push:
    tags:
      - "*.*.*"

permissions:
  contents: write
  packages: write

env:
  APP_NAME: ${{ github.event.repository.name }}
  IMAGE_NAME: ghcr.io/${{ github.repository }}

jobs:
  build-binaries:
    name: Build binaries (${{ matrix.goos }} / ${{ matrix.goarch }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: linux
            goarch: 386
          - goos: linux
            goarch: arm
            goarm: 6
          - goos: linux
            goarch: arm
            goarm: 7

          # Windows
          - goos: windows
            goarch: amd64
          - goos: windows
            goarch: 386

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Build binaries
        shell: bash
        run: |
          set -euo pipefail

          VERSION="${GITHUB_REF_NAME}"
          GOOS="${{ matrix.goos }}"
          GOARCH="${{ matrix.goarch }}"
          GOARM="${{ matrix.goarm || '' }}"

          mkdir -p dist

          BIN="${{ github.event.repository.name }}-${VERSION}-${GOOS}-${GOARCH}"
          if [ -n "$GOARM" ]; then
            BIN="${BIN}v${GOARM}"
          fi
          if [ "$GOOS" = "windows" ]; then
            BIN="${BIN}.exe"
          fi

          if [ -n "$GOARM" ]; then
            CGO_ENABLED=0 GOOS="$GOOS" GOARCH="$GOARCH" GOARM="$GOARM" \
              go build -trimpath -o "dist/${BIN}" .
          else
            CGO_ENABLED=0 GOOS="$GOOS" GOARCH="$GOARCH" \
              go build -trimpath -o "dist/${BIN}" .
          fi

          (cd dist && sha256sum "${BIN}" > "${BIN}.sha256")

      - name: Create/Update GitHub Release (draft) and upload binaries
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          draft: true
          files: |
            dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  docker-version:
    name: Build & push Docker image (version tag)
    runs-on: ubuntu-latest
    needs: [build-binaries]

    steps:
      - uses: actions/checkout@v4

      - uses: docker/setup-qemu-action@v3
      - uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          platforms: linux/amd64,linux/arm64,linux/386,linux/arm/v6,linux/arm/v7
          tags: |
            ${{ env.IMAGE_NAME }}:${{ github.ref_name }}
            ${{ env.IMAGE_NAME }}:latest
